<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta charset="utf-8">
<meta property="og:title" content="Making an eval command in C++ - D++ - The lightweight C++ Discord API Library">
<meta property="og:description" content="A lightweight C++ Discord API library supporting the entire Discord API, including Slash Commands, Voice/Audio, Sharding, Clustering and more!">
<meta name="description" content="Making an eval command in C++ - D++ - A lightweight C++ Discord API library supporting the entire Discord API, including Slash Commands, Voice/Audio, Sharding, Clustering and more!">
<meta property="og:image" content="https://dpp.dev/DPP-Logo.png">
<meta property="og:url" content="https://dpp.dev/">
<meta property="og:type" content="website">
<meta property="twitter:title" content="Making an eval command in C++ - D++ - The lightweight C++ Discord API Library">
<title>Making an eval command in C++ - D++ - The lightweight C++ Discord API Library</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="doxygen-awesome.css" rel="stylesheet" type="text/css"/>
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<script>
	setTimeout(function() {
		$("#main-menu").html($("#main-menu").html() + "<li><select name='vsv' onchange='window.location.href=this.options[this.selectedIndex].value'><option value='/'>master</option><option value='/10.0.29/'>10.0.29</option><option value='/10.0.28/'>10.0.28</option><option value='/10.0.27/'>10.0.27</option><option value='/10.0.26/'>10.0.26</option><option value='/10.0.25/'>10.0.25</option><option value='/10.0.24/'>10.0.24</option><option value='/10.0.23/'>10.0.23</option><option value='/10.0.22/'>10.0.22</option><option value='/10.0.21/'>10.0.21</option><option value='/10.0.20/'>10.0.20</option><option value='/10.0.19/'>10.0.19</option><option selected value='/10.0.18/'>10.0.18</option><option value='/10.0.17/'>10.0.17</option><option value='/10.0.16/'>10.0.16</option><option value='/10.0.15/'>10.0.15</option><option value='/10.0.14/'>10.0.14</option><option value='/10.0.13/'>10.0.13</option><option value='/10.0.12/'>10.0.12</option><option value='/10.0.11/'>10.0.11</option><option value='/10.0.10/'>10.0.10</option><option value='/10.0.9/'>10.0.9</option><option value='/10.0.8/'>10.0.8</option><option value='/10.0.7/'>10.0.7</option><option value='/10.0.6/'>10.0.6</option><option value='/10.0.5/'>10.0.5</option><option value='/10.0.4/'>10.0.4</option><option value='/10.0.3/'>10.0.3</option><option value='/10.0.2/'>10.0.2</option><option value='/10.0.1/'>10.0.1</option><option value='/10.0.0/'>10.0.0</option><option value='/9.0.19/'>9.0.19</option><option value='/9.0.18/'>9.0.18</option><option value='/9.0.17/'>9.0.17</option><option value='/9.0.16/'>9.0.16</option><option value='/9.0.15/'>9.0.15</option><option value='/9.0.14/'>9.0.14</option><option value='/9.0.13/'>9.0.13</option><option value='/9.0.12/'>9.0.12</option><option value='/9.0.11/'>9.0.11</option><option value='/9.0.10/'>9.0.10</option><option value='/9.0.9/'>9.0.9</option><option value='/9.0.8/'>9.0.8</option><option value='/9.0.7/'>9.0.7</option><option value='/9.0.6/'>9.0.6</option><option value='/9.0.5/'>9.0.5</option><option value='/9.0.4/'>9.0.4</option><option value='/9.0.3/'>9.0.3</option><option value='/9.0.2/'>9.0.2</option><option value='/9.0.1/'>9.0.1</option><option value='/9.0.0/'>9.0.0</option><option value='/1.0.2/'>1.0.2</option><option value='/1.0.1/'>1.0.1</option><option value='/1.0.0/'>1.0.0</option></select></li>");
	}, 500);
</script>
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr>
  <td id="projectlogo"><img alt="Logo" src="DPP-Logo.png"/></td>
  <td style="padding-left: 0.5em;">
   <div id="projectname">D++ (DPP)
   </div>
   <div id="projectbrief">C++ Discord API Bot Library</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<label for="MSearchField" style="display: none">Search</label>
<!-- Generated by Doxygen 1.9.3 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(document).ready(function(){initNavTree('cpp-eval-command-discord.html',''); initResizable(); });
/* @license-end */
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">Making an eval command in C++ </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h3><a class="anchor" id="autotoc_md77"></a>
What is an eval command anyway?</h3>
<p >Many times people will ask: "how do i make a command like 'eval' in C++". For the uninitiated, an <code>eval</code> command is a command often found in interpreted languages such as Javascript and Python, which allows the developer to pass in raw interpreter statements which are then executed within the context of the running program, without any sandboxing. Eval commands are plain <b>evil</b>, if not properly coded in.</p>
<p >Needless to say, this is very dangerous. If you are asking how to do this, and want to put this into your bot, we trust that you have a very good reason to do so and have considered alternatives before resorting to this. The code below is for educational purposes only and makes several assumptions:</p>
<ol type="1">
<li>This code will only operate on UNIX-like systems such as Linux (not <b>Darwin</b>)</li>
<li>It assumes you use GCC, and have <code>g++</code> installed on your server and in your $PATH</li>
<li>The program will attempt to write to the current directory</li>
<li>No security checks will be done against the code, except for to check that it is being run by the bot's developer by snowflake id. It is entirely possible to send an <code>!eval exit(0);</code> and make the bot quit, for example, or delete files from the host operating system, if misused or misconfigured.</li>
<li>You're willing to wait a few seconds for compilation before your evaluated code runs. There isn't a way around this, as C++ is a compiled language.</li>
</ol>
<p >To create this program you must create two files, <code>eval.h</code> and <code>eval.cpp</code>. The header file lists forward declarations of functions that you will be able to use directly within your <code>eval</code> code. As well as this the entire of D++ will be available to the eval command via the local variable <code>bot</code>, and the entire <code>on_message_create</code> event variable via a local variable called <code>event</code>.</p>
<p >The evaluated code will run within its own thread, so can execute for as long as it needs (but use common sense, don't go spawning a tight <code>while</code> loop that runs forever, you'll lock a thread at 100% CPU that won't ever end!).</p>
<h3><a class="anchor" id="autotoc_md78"></a>
Implementation details</h3>
<p >This code operates by outputting your provided code to be evaluated into a simple boilerplate program which can be compiled to a shared object library (.so file). This .so file is then compiled with g++, using the <code>-shared</code> and <code>-fPIC</code> flags. If the program can be successfully compiled, it is then loaded using <code>dlopen()</code>, and the symbol <code>so_exec()</code> searched for within it, and called. This <code>so_exec()</code> function will contain the body of the code given to the eval command. Once this has been called and it has returned, the <code>dlclose()</code> function is called to unload the library, and finally any temporary files (such as the .so file and its corresponding .cpp file) are cleaned up. Docker is definitely recommended if you code on Windows/Mac OS, because docker desktop still uses a linux VM, so your code can easily use <code>.so</code> file and your code runs the same on your vps (if it also uses Linux distro)</p>
<h3><a class="anchor" id="autotoc_md79"></a>
Source code</h3>
<dl class="section warning"><dt>Warning</dt><dd>If you manage to get your system, network, or anything else harmed by use or misuse of this code, we are not responsible. Don't say we didn't warn you! Find another way to solve your problem!</dd></dl>
<h4><a class="anchor" id="autotoc_md80"></a>
eval.h</h4>
<p >Remember that eval.h contains forward-declarations of any functions you want to expose to the eval command. It is included both by the bot itself, and by any shared object files compiled for evaluation.</p>
<div class="fragment"><div class="line"><span class="preprocessor">#pragma once</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* This is the snowflake ID of the bot&#39;s developer.</span></div>
<div class="line"><span class="comment"> * The eval command will be restricted to this user.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="preprocessor">#define MY_DEVELOPER 189759562910400512</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Any functions you want to be usable from within an eval,</span></div>
<div class="line"><span class="comment"> * that are not part of D++ itself or the message event, you</span></div>
<div class="line"><span class="comment"> * can put here as forward declarations. The test_function()</span></div>
<div class="line"><span class="comment"> * serves as an example.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">int</span> test_function();</div>
</div><!-- fragment --><h4><a class="anchor" id="autotoc_md81"></a>
eval.cpp</h4>
<p >This is the main body of the example program.</p>
<div class="fragment"><div class="line"> </div>
<div class="line"><span class="preprocessor">#include &lt;dpp/dpp.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fmt/format.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;fstream&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;iostream&gt;</span></div>
<div class="line"><span class="comment">/* We have to define this to make certain functions visible */</span></div>
<div class="line"><span class="preprocessor">#ifndef _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">        #define _GNU_SOURCE</span></div>
<div class="line"><span class="preprocessor">#endif</span></div>
<div class="line"><span class="preprocessor">#include &lt;link.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &lt;dlfcn.h&gt;</span></div>
<div class="line"><span class="preprocessor">#include &quot;eval.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="comment">/* This is an example function you can expose to your eval command */</span></div>
<div class="line"><span class="keywordtype">int</span> test_function() {</div>
<div class="line">    <span class="keywordflow">return</span> 42;</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="comment">/* Important: This code is for UNIX-like systems only, e.g.</span></div>
<div class="line"><span class="comment"> * Linux, BSD, OSX. It will NOT work on Windows!</span></div>
<div class="line"><span class="comment"> * Note for OSX you&#39;ll probably have to change all references</span></div>
<div class="line"><span class="comment"> * from .so to .dylib.</span></div>
<div class="line"><span class="comment"> */</span></div>
<div class="line"><span class="keywordtype">int</span> main()</div>
<div class="line">{</div>
<div class="line">    <a class="code hl_class" href="classdpp_1_1cluster.html">dpp::cluster</a> bot(<span class="stringliteral">&quot;token&quot;</span>, <a class="code hl_enumvalue" href="namespacedpp.html#a0042c0fc8164da4239b977d5be8e2ef5a561a52b3c6883808735c41891351c68f">dpp::i_default_intents</a> | <a class="code hl_enumvalue" href="namespacedpp.html#a0042c0fc8164da4239b977d5be8e2ef5a27810e825c157ded5d59df6dede23414">dpp::i_message_content</a>);</div>
<div class="line"> </div>
<div class="line">        bot.on_log(<a class="code hl_function" href="namespacedpp_1_1utility.html#a8c2cc04bb80ffd287b376d5977899277">dpp::utility::cout_logger</a>());</div>
<div class="line"> </div>
<div class="line">    <span class="comment">/* This won&#39;t work in a slash command very well yet, as there is not yet</span></div>
<div class="line"><span class="comment">     * a multi-line slash command input type.</span></div>
<div class="line"><span class="comment">     */</span></div>
<div class="line">    bot.on_message_create([&amp;bot](<span class="keyword">const</span> <span class="keyword">auto</span> &amp; event) {</div>
<div class="line">        <span class="keywordflow">if</span> (<a class="code hl_function" href="namespacedpp_1_1utility.html#afa6985aaa798fa30b73c1decc418cd32">dpp::utility::utf8substr</a>(event.msg.content, 0, 5) == <span class="stringliteral">&quot;!eval&quot;</span>) {</div>
<div class="line"> </div>
<div class="line">            if (event.msg.author.id != MY_DEVELOPER) {</div>
<div class="line">                bot.message_create(dpp::message(event.msg.channel_id, <span class="stringliteral">&quot;On the day i do this for you, Satan will be ice skating to work.&quot;</span>));</div>
<div class="line">                return;</div>
<div class="line">            }</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* We start by creating a string that contains a cpp program for a simple library.</span></div>
<div class="line"><span class="comment">             * The library will contain one exported function called so_exec() that is called</span></div>
<div class="line"><span class="comment">             * containing the raw C++ code to eval.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            std::string code = <span class="stringliteral">&quot;#include &lt;iostream&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;string&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;map&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;unordered_map&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;stdint.h&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;dpp/dpp.h&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;dpp/nlohmann/json.hpp&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include &lt;fmt/format.h&gt;\n\</span></div>
<div class="line"><span class="stringliteral">                #include \&quot;eval.h\&quot;\n\</span></div>
<div class="line"><span class="stringliteral">                extern \&quot;C\&quot; void so_exec(dpp::cluster&amp; bot, dpp::message_create_t event) {\n\</span></div>
<div class="line"><span class="stringliteral">                    &quot;</span> + <a class="code hl_function" href="namespacedpp_1_1utility.html#afa6985aaa798fa30b73c1decc418cd32">dpp::utility::utf8substr</a>(</div>
<div class="line">                        event.msg.content,</div>
<div class="line">                        6,</div>
<div class="line">                        <a class="code hl_function" href="namespacedpp_1_1utility.html#a62cc8fc3994f6b3d49cf4923b993c231">dpp::utility::utf8len</a>(event.msg.content)</div>
<div class="line">                    ) + <span class="stringliteral">&quot;;\n\</span></div>
<div class="line"><span class="stringliteral">                    return;\n\</span></div>
<div class="line"><span class="stringliteral">                }&quot;</span>;</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Next we output this string full of C++ to a cpp file on disk.</span></div>
<div class="line"><span class="comment">             * This code assumes the current directory is writeable. The file will have a</span></div>
<div class="line"><span class="comment">             * unique name made from the user&#39;s id and the message id.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">                std::string source_filename = std::to_string(event.msg.author.id) + <span class="stringliteral">&quot;_&quot;</span> + std::to_string(event.msg.id) + <span class="stringliteral">&quot;.cpp&quot;</span>;</div>
<div class="line">            std::fstream code_file(source_filename, std::fstream::binary | std::fstream::out);</div>
<div class="line">            <span class="keywordflow">if</span> (!code_file.is_open()) {</div>
<div class="line">                bot.message_create(dpp::message(event.msg.channel_id, <span class="stringliteral">&quot;Unable to create source file for `eval`&quot;</span>));</div>
<div class="line">                return;</div>
<div class="line">            }</div>
<div class="line">            code_file &lt;&lt; code;</div>
<div class="line">            code_file.close();</div>
<div class="line"> </div>
<div class="line">            <span class="comment">/* Now to actually compile the file. We use dpp::utility::exec to</span></div>
<div class="line"><span class="comment">             * invoke a compiler. This assumes you are using g++, and it is in your path.</span></div>
<div class="line"><span class="comment">             */</span></div>
<div class="line">            <span class="keywordtype">double</span> compile_start = <a class="code hl_function" href="namespacedpp_1_1utility.html#a1184092d62c7ab561cb3f60a92f71b67">dpp::utility::time_f</a>();</div>
<div class="line">            <a class="code hl_function" href="namespacedpp_1_1utility.html#ac7d516c03d572fe65d01c4ec5e92c6f0">dpp::utility::exec</a>(<span class="stringliteral">&quot;g++&quot;</span>, {</div>
<div class="line">                <span class="stringliteral">&quot;-std=c++17&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;-shared&quot;</span>,  <span class="comment">/* Build the output as a .so file */</span></div>
<div class="line">                <span class="stringliteral">&quot;-fPIC&quot;</span>,</div>
<div class="line">                std::string(<span class="stringliteral">&quot;-o&quot;</span>) + std::to_string(event.msg.author.id) + <span class="stringliteral">&quot;_&quot;</span> + std::to_string(event.msg.id) + <span class="stringliteral">&quot;.so&quot;</span>,</div>
<div class="line">                std::to_string(event.msg.author.id) + <span class="stringliteral">&quot;_&quot;</span> + std::to_string(event.msg.id) + <span class="stringliteral">&quot;.cpp&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;-ldpp&quot;</span>,</div>
<div class="line">                <span class="stringliteral">&quot;-ldl&quot;</span></div>
<div class="line">            }, [event, &amp;bot, source_filename, compile_start](<span class="keyword">const</span> std::string &amp;output) {</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* After g++ is ran we end up inside this lambda with the output as a string */</span></div>
<div class="line">                double compile_time = dpp::utility::time_f() - compile_start;</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* Delete our cpp file, we don&#39;t need it any more */</span></div>
<div class="line">                std::string del_file = std::string(getenv(<span class="stringliteral">&quot;PWD&quot;</span>)) + std::to_string(event.msg.author.id) + <span class="stringliteral">&quot;_&quot;</span> + std::to_string(event.msg.id) + <span class="stringliteral">&quot;.cpp&quot;</span>;</div>
<div class="line">                unlink(del_file.c_str());</div>
<div class="line"> </div>
<div class="line">                <span class="comment">/* On successful compilation g++ outputs nothing, so any output here is error output */</span></div>
<div class="line">                if (output.length()) {</div>
<div class="line">                    bot.message_create(dpp::message(event.msg.channel_id, <span class="stringliteral">&quot;Compile error: ```\n&quot;</span> + output + <span class="stringliteral">&quot;\n```&quot;</span>));</div>
<div class="line">                } <span class="keywordflow">else</span> {</div>
<div class="line">                    </div>
<div class="line">                    <span class="comment">/* Now for the meat of the function. To actually load</span></div>
<div class="line"><span class="comment">                     * our shared object we use dlopen() to load it into the</span></div>
<div class="line"><span class="comment">                     * memory space of our bot. If dlopen() returns a nullptr,</span></div>
<div class="line"><span class="comment">                     * the shared object could not be loaded. The user probably</span></div>
<div class="line"><span class="comment">                     * did something odd with the symbols inside their eval.</span></div>
<div class="line"><span class="comment">                     */</span></div>
<div class="line">                    std::string dl = std::string(getenv(<span class="stringliteral">&quot;PWD&quot;</span>)) + std::to_string(event.msg.author.id) + <span class="stringliteral">&quot;_&quot;</span> + std::to_string(event.msg.id) + <span class="stringliteral">&quot;.so&quot;</span>,</div>
<div class="line">                    auto shared_object_handle = dlopen(dl.c_str(), RTLD_NOW);</div>
<div class="line">                    if (!shared_object_handle) {</div>
<div class="line">                        const char *dlsym_error = dlerror();</div>
<div class="line">                        bot.message_create(dpp::message(event.msg.channel_id, <span class="stringliteral">&quot;Shared object load error: ```\n&quot;</span> +</div>
<div class="line">                            std::string(dlsym_error ? dlsym_error : <span class="stringliteral">&quot;Unknown error&quot;</span>) +<span class="stringliteral">&quot;\n```&quot;</span>));</div>
<div class="line">                        return;</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* This type represents the &quot;void so_exec()&quot; function inside</span></div>
<div class="line"><span class="comment">                     * the shared object library file.</span></div>
<div class="line"><span class="comment">                     */</span></div>
<div class="line">                    <span class="keyword">using</span> function_pointer = <span class="keywordtype">void</span>(*)(<a class="code hl_class" href="classdpp_1_1cluster.html">dpp::cluster</a>&amp;, <a class="code hl_struct" href="structdpp_1_1message__create__t.html">dpp::message_create_t</a>);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Attempt to find the function called so_exec() inside the</span></div>
<div class="line"><span class="comment">                     * library we just loaded. If we can&#39;t find it, then the user</span></div>
<div class="line"><span class="comment">                     * did something really strange in their eval. Also note it&#39;s</span></div>
<div class="line"><span class="comment">                     * important we call dlerror() here to reset it before trying</span></div>
<div class="line"><span class="comment">                     * to use it a second time. It&#39;s weird-ass C code and is just</span></div>
<div class="line"><span class="comment">                     * like that.</span></div>
<div class="line"><span class="comment">                     */</span></div>
<div class="line">                    dlerror();</div>
<div class="line">                    function_pointer exec_run = (function_pointer)dlsym(shared_object_handle, <span class="stringliteral">&quot;so_exec&quot;</span>);</div>
<div class="line">                    <span class="keyword">const</span> <span class="keywordtype">char</span> *dlsym_error = dlerror();</div>
<div class="line">                    <span class="keywordflow">if</span> (dlsym_error) {</div>
<div class="line">                        bot.message_create(<a class="code hl_struct" href="structdpp_1_1message.html">dpp::message</a>(event.msg.channel_id, <span class="stringliteral">&quot;Shared object load error: ```\n&quot;</span> + std::string(dlsym_error) +<span class="stringliteral">&quot;\n```&quot;</span>));</div>
<div class="line">                        dlclose(shared_object_handle);</div>
<div class="line">                        <span class="keywordflow">return</span>;</div>
<div class="line">                    }</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Now we have a function pointer to our actual exec code in</span></div>
<div class="line"><span class="comment">                     * &#39;exec_run&#39;, so lets call it, and pass it a reference to</span></div>
<div class="line"><span class="comment">                     * the cluster, and also a copy of the message_create_t.</span></div>
<div class="line"><span class="comment">                     */</span></div>
<div class="line">                    <span class="keywordtype">double</span> run_start = <a class="code hl_function" href="namespacedpp_1_1utility.html#a1184092d62c7ab561cb3f60a92f71b67">dpp::utility::time_f</a>();</div>
<div class="line">                    exec_run(bot, event);</div>
<div class="line">                    <span class="keywordtype">double</span> run_time = <a class="code hl_function" href="namespacedpp_1_1utility.html#a1184092d62c7ab561cb3f60a92f71b67">dpp::utility::time_f</a>() - run_start;</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* When we&#39;re done with a .so file we must always dlclose() it */</span></div>
<div class="line">                    dlclose(shared_object_handle);</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* We are now done with the compiled code too */</span></div>
<div class="line">                    unlink(dl.c_str());</div>
<div class="line"> </div>
<div class="line">                    <span class="comment">/* Output some statistics */</span></div>
<div class="line">                    bot.message_create(<a class="code hl_struct" href="structdpp_1_1message.html">dpp::message</a>(event.msg.channel_id,</div>
<div class="line">                        <span class="stringliteral">&quot;Execution completed. Compile time: &quot;</span> + std::to_string(compile_time) +</div>
<div class="line">                        <span class="stringliteral">&quot;s, execution time &quot;</span> + std::to_string(run_time) + <span class="stringliteral">&quot;s&quot;</span>));</div>
<div class="line">                }</div>
<div class="line">            });</div>
<div class="line">        }</div>
<div class="line">    });</div>
<div class="line"> </div>
<div class="line">    bot.start(<a class="code hl_enumvalue" href="namespacedpp.html#af447e04d0490cd4a9de085e4a758faa4a155f7db65696b4c09b5fcc41787e4726">dpp::st_wait</a>);</div>
<div class="line">    <span class="keywordflow">return</span> 0;</div>
<div class="line">}</div>
<div class="ttc" id="aclassdpp_1_1cluster_html"><div class="ttname"><a href="classdpp_1_1cluster.html">dpp::cluster</a></div><div class="ttdoc">The cluster class represents a group of shards and a command queue for sending and receiving commands...</div><div class="ttdef"><b>Definition:</b> cluster.h:271</div></div>
<div class="ttc" id="anamespacedpp_1_1utility_html_a1184092d62c7ab561cb3f60a92f71b67"><div class="ttname"><a href="namespacedpp_1_1utility.html#a1184092d62c7ab561cb3f60a92f71b67">dpp::utility::time_f</a></div><div class="ttdeci">double DPP_EXPORT time_f()</div><div class="ttdoc">Return the current time with fractions of seconds. This is a unix epoch time with the fractional seco...</div></div>
<div class="ttc" id="anamespacedpp_1_1utility_html_a62cc8fc3994f6b3d49cf4923b993c231"><div class="ttname"><a href="namespacedpp_1_1utility.html#a62cc8fc3994f6b3d49cf4923b993c231">dpp::utility::utf8len</a></div><div class="ttdeci">size_t DPP_EXPORT utf8len(const std::string &amp;str)</div><div class="ttdoc">Returns the length of a UTF-8 string in codepoints.</div></div>
<div class="ttc" id="anamespacedpp_1_1utility_html_a8c2cc04bb80ffd287b376d5977899277"><div class="ttname"><a href="namespacedpp_1_1utility.html#a8c2cc04bb80ffd287b376d5977899277">dpp::utility::cout_logger</a></div><div class="ttdeci">std::function&lt; void(const dpp::log_t &amp;)&gt; DPP_EXPORT cout_logger()</div><div class="ttdoc">Get a default logger that outputs to std::cout. e.g.</div></div>
<div class="ttc" id="anamespacedpp_1_1utility_html_ac7d516c03d572fe65d01c4ec5e92c6f0"><div class="ttname"><a href="namespacedpp_1_1utility.html#ac7d516c03d572fe65d01c4ec5e92c6f0">dpp::utility::exec</a></div><div class="ttdeci">void DPP_EXPORT exec(const std::string &amp;cmd, std::vector&lt; std::string &gt; parameters={}, cmd_result_t callback={})</div><div class="ttdoc">Run a commandline program asynchronously. The command line program is spawned in a separate std::thre...</div></div>
<div class="ttc" id="anamespacedpp_1_1utility_html_afa6985aaa798fa30b73c1decc418cd32"><div class="ttname"><a href="namespacedpp_1_1utility.html#afa6985aaa798fa30b73c1decc418cd32">dpp::utility::utf8substr</a></div><div class="ttdeci">std::string DPP_EXPORT utf8substr(const std::string &amp;str, std::string::size_type start, std::string::size_type length)</div><div class="ttdoc">Return substring of a UTF-8 encoded string in codepoints.</div></div>
<div class="ttc" id="anamespacedpp_html_a0042c0fc8164da4239b977d5be8e2ef5a27810e825c157ded5d59df6dede23414"><div class="ttname"><a href="namespacedpp.html#a0042c0fc8164da4239b977d5be8e2ef5a27810e825c157ded5d59df6dede23414">dpp::i_message_content</a></div><div class="ttdeci">@ i_message_content</div><div class="ttdoc">Intent for receipt of message content.</div><div class="ttdef"><b>Definition:</b> intents.h:64</div></div>
<div class="ttc" id="anamespacedpp_html_a0042c0fc8164da4239b977d5be8e2ef5a561a52b3c6883808735c41891351c68f"><div class="ttname"><a href="namespacedpp.html#a0042c0fc8164da4239b977d5be8e2ef5a561a52b3c6883808735c41891351c68f">dpp::i_default_intents</a></div><div class="ttdeci">@ i_default_intents</div><div class="ttdoc">Default D++ intents (all non-privileged intents)</div><div class="ttdef"><b>Definition:</b> intents.h:72</div></div>
<div class="ttc" id="anamespacedpp_html_af447e04d0490cd4a9de085e4a758faa4a155f7db65696b4c09b5fcc41787e4726"><div class="ttname"><a href="namespacedpp.html#af447e04d0490cd4a9de085e4a758faa4a155f7db65696b4c09b5fcc41787e4726">dpp::st_wait</a></div><div class="ttdeci">@ st_wait</div><div class="ttdoc">Wait forever on a condition variable. The cluster will spawn threads for each shard and start() will ...</div><div class="ttdef"><b>Definition:</b> cluster.h:254</div></div>
<div class="ttc" id="astructdpp_1_1message__create__t_html"><div class="ttname"><a href="structdpp_1_1message__create__t.html">dpp::message_create_t</a></div><div class="ttdoc">Create message.</div><div class="ttdef"><b>Definition:</b> dispatcher.h:1354</div></div>
<div class="ttc" id="astructdpp_1_1message_html"><div class="ttname"><a href="structdpp_1_1message.html">dpp::message</a></div><div class="ttdoc">Represents messages sent and received on Discord.</div><div class="ttdef"><b>Definition:</b> message.h:1105</div></div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md82"></a>
Compilation</h3>
<p >To compile this program you must link against <code>libdl</code>. It is also critically important to include the <code>-rdynamic</code> flag. For example:</p>
<div class="fragment"><div class="line">g++ -std=c++17 -rdynamic -oeval eval.cpp -ldpp -ldl</div>
</div><!-- fragment --><h3><a class="anchor" id="autotoc_md83"></a>
Example usage</h3>
<div class="image">
<img src="eval_example.png" alt=""/>
</div>
 </div></div><!-- contents --><script src="https://giscus.app/client.js" data-repo="brainboxdotcc/dpp-comments" data-repo-id="R_kgDOHOY4xg" data-category="General" data-category-id="DIC_kwDOHOY4xs4CRYtj" data-mapping="pathname" data-strict="1" data-reactions-enabled="1" data-emit-metadata="1" data-input-position="top" data-theme="preferred_color_scheme" data-lang="en" data-loading="lazy" crossorigin="anonymous" async></script>
</div><!-- PageDoc -->
</div><!-- doc-content -->
<div id="nav-path" class="navpath">
	<ul>
		<li class="navelem"><a class="el" href="md_docpages_03_example_programs.html">Example Programs</a></li><li class="navelem"><a class="el" href="misc.html">Miscellaneous Examples</a></li>
	</ul>
</div>
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-QTH6YHBNG5"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/styles/base16/dracula.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.6.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlightjs-line-numbers.js/2.8.0/highlightjs-line-numbers.min.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@100&display=swap" rel="stylesheet">
<script>
	window.dataLayer = window.dataLayer || [];
	function gtag(){dataLayer.push(arguments);}
	gtag('js', new Date());
	gtag('config', 'G-QTH6YHBNG5');
	$(function() {
		$(".fragment").each(function(i,node) {
			var $node = $(node);
			$node.children(":not(.line)").remove();
			$node.html("<pre><code class='stan'>" + $node.text().trim().replaceAll("<", "&lt;").replaceAll(">", "&gt;") + "</code></pre>");
			hljs.configure({
				languages: ['cpp','diff','cmake','bash','sh','text'],
				ignoreUnescapedHTML: true
			});
			hljs.highlightAll(node);
			hljs.initLineNumbersOnLoad(node);  
		});
		$(".fragment").parent().parent().parent().parent().removeClass('doxtable');
	});
</script>
<style>
	.hljs-ln-code, code, code a, pre.fragment, div.fragment, div.fragment .line, div.fragment span, div.fragment .line a, div.fragment .line span {
		font-family: 'JetBrains Mono', monospace !important;
		font-size: 0.8rem !important;
	}
	.fragment {
		padding: 0 !important;
		margin-top: 0 !important;
		margin-bottom: 0 !important;
		background: none !important;
		border: 0 !important;
	}
	.hljs-ln-n::before {
		content: attr(data-line-number);
		padding-right: 1rem !important;
	}
	table.markdownTable code td, table.markdownTable code th, table.fieldtable code td, table.fieldtable code th, table.doxtable code td, table.doxtable code th {
		border: 0 !important;
		padding: 0 !important;
	}	
</style>
<div style="z-index: -9999; position: absolute; right: 0; top: 0; font-size: 0.0001rem;color:transparent;background:none">
	<!-- For crawlability of past versions -->
	<a href='/10.0.29/'>D++ Library version 10.0.29</a><a href='/10.0.28/'>D++ Library version 10.0.28</a><a href='/10.0.27/'>D++ Library version 10.0.27</a><a href='/10.0.26/'>D++ Library version 10.0.26</a><a href='/10.0.25/'>D++ Library version 10.0.25</a><a href='/10.0.24/'>D++ Library version 10.0.24</a><a href='/10.0.23/'>D++ Library version 10.0.23</a><a href='/10.0.22/'>D++ Library version 10.0.22</a><a href='/10.0.21/'>D++ Library version 10.0.21</a><a href='/10.0.20/'>D++ Library version 10.0.20</a><a href='/10.0.19/'>D++ Library version 10.0.19</a><a href='/10.0.18/'>D++ Library version 10.0.18</a><a href='/10.0.17/'>D++ Library version 10.0.17</a><a href='/10.0.16/'>D++ Library version 10.0.16</a><a href='/10.0.15/'>D++ Library version 10.0.15</a><a href='/10.0.14/'>D++ Library version 10.0.14</a><a href='/10.0.13/'>D++ Library version 10.0.13</a><a href='/10.0.12/'>D++ Library version 10.0.12</a><a href='/10.0.11/'>D++ Library version 10.0.11</a><a href='/10.0.10/'>D++ Library version 10.0.10</a><a href='/10.0.9/'>D++ Library version 10.0.9</a><a href='/10.0.8/'>D++ Library version 10.0.8</a><a href='/10.0.7/'>D++ Library version 10.0.7</a><a href='/10.0.6/'>D++ Library version 10.0.6</a><a href='/10.0.5/'>D++ Library version 10.0.5</a><a href='/10.0.4/'>D++ Library version 10.0.4</a><a href='/10.0.3/'>D++ Library version 10.0.3</a><a href='/10.0.2/'>D++ Library version 10.0.2</a><a href='/10.0.1/'>D++ Library version 10.0.1</a><a href='/10.0.0/'>D++ Library version 10.0.0</a><a href='/9.0.19/'>D++ Library version 9.0.19</a><a href='/9.0.18/'>D++ Library version 9.0.18</a><a href='/9.0.17/'>D++ Library version 9.0.17</a><a href='/9.0.16/'>D++ Library version 9.0.16</a><a href='/9.0.15/'>D++ Library version 9.0.15</a><a href='/9.0.14/'>D++ Library version 9.0.14</a><a href='/9.0.13/'>D++ Library version 9.0.13</a><a href='/9.0.12/'>D++ Library version 9.0.12</a><a href='/9.0.11/'>D++ Library version 9.0.11</a><a href='/9.0.10/'>D++ Library version 9.0.10</a><a href='/9.0.9/'>D++ Library version 9.0.9</a><a href='/9.0.8/'>D++ Library version 9.0.8</a><a href='/9.0.7/'>D++ Library version 9.0.7</a><a href='/9.0.6/'>D++ Library version 9.0.6</a><a href='/9.0.5/'>D++ Library version 9.0.5</a><a href='/9.0.4/'>D++ Library version 9.0.4</a><a href='/9.0.3/'>D++ Library version 9.0.3</a><a href='/9.0.2/'>D++ Library version 9.0.2</a><a href='/9.0.1/'>D++ Library version 9.0.1</a><a href='/9.0.0/'>D++ Library version 9.0.0</a><a href='/1.0.2/'>D++ Library version 1.0.2</a><a href='/1.0.1/'>D++ Library version 1.0.1</a><a href='/1.0.0/'>D++ Library version 1.0.0</a>
</div>
</body>
</html>
